<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>نظام الحضور والانصراف (QR)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #f3f4f6; }
        #reader { width:100%; max-width:400px; margin:0 auto; border-radius:12px; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        .container { padding:20px; }
        .btn-primary { background-color: #10b981; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #059669; }
        .btn-secondary { background-color: #3b82f6; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #2563eb; }
    </style>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="min-h-screen">

    <!-- شاشة تسجيل الدخول -->
    <div id="login-container" class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100">
        <div class="w-full max-w-md p-8 bg-white rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">تسجيل الدخول للنظام</h1>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">اسم المستخدم</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="أدخل اسم المستخدم">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="أدخل كلمة المرور">
                </div>
                <div id="login-message" class="text-center text-red-600 font-medium hidden"></div>
                <button type="submit" class="btn-secondary w-full py-3 px-4 border border-transparent rounded-md text-white font-semibold shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    دخول
                </button>
            </form>
        </div>
        <p class="mt-4 text-xs text-gray-500">للتعديل: يمكنك تغيير بيانات الدخول في قسم الكود (JS).</p>
    </div>

    <!-- المحتوى الرئيسي للتطبيق -->
    <div id="main-app-content" class="container mx-auto max-w-4xl hidden">
        <h1 class="text-4xl font-bold text-center text-gray-800 my-6">نظام حضور وانصراف الموظفين</h1>
        <p id="user-info" class="text-center text-sm text-gray-500 mb-6"></p>

        <!-- ماسح QR -->
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">1. المسح التلقائي عبر الكاميرا</h2>
            <div id="reader-container" class="flex justify-center">
                <div id="reader"></div>
            </div>
            <div id="scan-status" class="mt-4 text-center text-lg font-medium text-blue-600"></div>
            <div id="last-scan-result" class="mt-2 p-3 bg-green-100 text-green-800 rounded-lg hidden"></div>

            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-center shadow-inner">
                <span class="text-md font-medium text-gray-600">عدد حركات المسح اليوم (QR): </span>
                <span id="qr-count-display" class="text-2xl font-extrabold text-green-600">0</span>
            </div>
        </div>

        <!-- الادخال اليدوي -->
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">2. الإدخال اليدوي</h2>
            <form id="manual-entry-form" class="space-y-4">
                <div>
                    <label for="employee-id-manual" class="block text-sm font-medium text-gray-700">رمز الموظف (الموجود في QR Code)</label>
                    <input type="text" id="employee-id-manual" name="employee-id-manual" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500" placeholder="EMP12345">
                </div>
                <div>
                    <label for="movement-type-manual" class="block text-sm font-medium text-gray-700">نوع الحركة</label>
                    <select id="movement-type-manual" name="movement-type-manual" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:ring-green-500 focus:border-green-500">
                        <option value="Clock In">دخول</option>
                        <option value="Clock Out">انصراف</option>
                        <option value="Evening Clock Out">انصراف مسائي</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary w-full py-3 px-4 border border-transparent rounded-md text-white font-semibold shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    تسجيل الحركة يدوياً
                </button>
            </form>
            <div id="manual-entry-message" class="mt-4 text-center text-lg font-medium text-red-600 hidden"></div>
        </div>

        <!-- سجل الحركات -->
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">3. سجل الحركات</h2>
                <button id="export-excel-btn" class="btn-secondary py-2 px-4 border border-transparent rounded-md text-white font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    تصدير إلى Excel (CSV)
                </button>
            </div>
            <div id="records-list" class="space-y-3">
                <p class="text-center text-gray-500" id="loading-records"></p>
            </div>
        </div>
    </div>

    <script>
    // ------------ إعدادات ------------
    const CREDENTIALS = { username: "admin", password: "123" };
    // ضع هنا رابط Web App الخاص بك (Apps Script)
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzGJy8WInLBIJGuqa90bDMWuK9SIHOJ4IH5No8EcvdPWJQsmUKfQqrPNe5aFB7pCwE-sA/exec';

    // ------------ حالة محلية (عرض / تصدير) ------------
    const LS_ALL_RECORDS_KEY = 'attendance_all_records_v1';
    let allRecords = loadAllRecordsFromStorage();

    const movementTypeMap = {
        "Clock In": "دخول",
        "Clock Out": "انصراف",
        "Evening Clock Out": "انصراف مسائي"
    };

    // ------------ helpers التخزين ------------
    function saveAllRecordsToStorage() {
        try { localStorage.setItem(LS_ALL_RECORDS_KEY, JSON.stringify(allRecords)); } catch (e) { console.warn(e); }
    }
    function loadAllRecordsFromStorage() {
        try {
            const s = localStorage.getItem(LS_ALL_RECORDS_KEY);
            return s ? JSON.parse(s) : [];
        } catch (e) { console.warn(e); return []; }
    }

    // ------------ دوال إنشاء السجل وإرساله فورًا ------------
    function createLocalRecord(employeeId, type, source = 'QR') {
        return {
            id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
            employee_id: String(employeeId).trim(),
            movement_type: type,
            timestamp: new Date().toISOString(),
            source: source
        };
    }

    // إرسال سجل واحد فورًا إلى Google Sheet (records_batch كـ JSON array)
    async function sendRecordImmediately(record) {
        // حفظ محليًا للعرض
        allRecords.unshift(record);
        saveAllRecordsToStorage();
        renderRecords(allRecords.slice(0, 20));
        updateQRCountFromAllRecords();
        document.getElementById('export-excel-btn').disabled = allRecords.length === 0;

        // تجهيز payload متوافق مع Apps Script (records_batch)
        const params = new URLSearchParams();
        params.append('records_batch', JSON.stringify([{
            id: record.id,
            employee_id: record.employee_id,
            movement_type: record.movement_type,
            timestamp: record.timestamp,
            source: record.source
        }]));

        // محاولة إرسال باستخدام fetch (no-cors)، ثم fallback إلى sendBeacon إذا متوفر
        try {
            await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // يضمن إرسال الطلب غالبًا مع Apps Script Web App
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            console.log('تم إرسال السجل (no-cors) إلى Google Sheet:', record);
        } catch (e) {
            console.warn('fetch(no-cors) فشل، محاولة sendBeacon إذا كانت متاحة:', e);
            try {
                if (navigator.sendBeacon) {
                    const blob = new Blob([params.toString()], { type: 'application/x-www-form-urlencoded' });
                    const ok = navigator.sendBeacon(GOOGLE_SHEET_WEB_APP_URL, blob);
                    console.log('sendBeacon result:', ok);
                }
            } catch (be) {
                console.warn('sendBeacon فشل:', be);
            }
        }
    }

    // ------------ عرض السجلات في الواجهة ------------
    function renderRecords(records) {
        const recordsList = document.getElementById('records-list');
        recordsList.innerHTML = '';

        if (!records || records.length === 0) {
            recordsList.innerHTML = '<p class="text-center text-gray-500">لا توجد سجلات حضور مسجلة بعد.</p>';
            return;
        }

        records.forEach(record => {
            const ts = record.timestamp ? new Date(record.timestamp) : new Date();
            const formattedTime = ts.toLocaleString('ar-EG', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            });

            const movementText = movementTypeMap[record.movement_type] || record.movement_type || '';
            const sourceText = (record.source === 'QR' || record.source === 'qr') ? 'مسح QR' : 'يدوي';

            const bgColor = (record.movement_type === 'Clock In') ? 'bg-blue-50' :
                            ((record.movement_type === 'Clock Out') ? 'bg-yellow-50' : 'bg-red-50');
            const borderColor = (record.movement_type === 'Clock In') ? 'border-blue-300' :
                            ((record.movement_type === 'Clock Out') ? 'border-yellow-300' : 'border-red-300');

            const recordItem = `
                <div class="p-4 border-r-4 ${borderColor} ${bgColor} rounded-lg flex justify-between items-center shadow-sm">
                    <div>
                        <p class="text-lg font-bold text-gray-800">${movementText}</p>
                        <p class="text-sm text-gray-600">رمز الموظف: <span class="font-semibold">${record.employee_id}</span></p>
                    </div>
                    <div class="text-left">
                        <p class="text-sm text-gray-500">${formattedTime}</p>
                        <span class="text-xs font-medium ${record.source === 'QR' ? 'text-green-600' : 'text-purple-600'}">(${sourceText})</span>
                    </div>
                </div>
            `;
            recordsList.innerHTML += recordItem;
        });
    }

    // ------------ تصدير CSV ------------
    function exportToCSV(data) {
        const rows = (data || []).slice().sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
        const headers = ["معرف السجل", "رمز الموظف", "نوع الحركة", "الوقت والتاريخ", "المصدر"];
        let csv = headers.join(',') + '\n';

        const escape = (value) => {
            if (value === null || value === undefined) return '';
            let str = String(value);
            if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        rows.forEach(record => {
            csv += [
                escape(record.id),
                escape(record.employee_id),
                escape(movementTypeMap[record.movement_type] || record.movement_type || ''),
                escape(new Date(record.timestamp).toLocaleString('en-US', { hour12: false })),
                escape(record.source)
            ].join(',') + '\n';
        });

        const csvFile = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(csvFile);
        link.download = `Attendance_Records_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    document.getElementById('export-excel-btn').addEventListener('click', () => {
        if (allRecords.length > 0) exportToCSV(allRecords);
    });

    // ------------ إدخال يدوي: إرسال مباشر ------------
    document.getElementById('manual-entry-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const employeeId = document.getElementById('employee-id-manual').value;
        const type = document.getElementById('movement-type-manual').value;
        const msgEl = document.getElementById('manual-entry-message');
        msgEl.textContent = 'جاري التسجيل...';
        msgEl.classList.remove('hidden','bg-green-100','text-green-800');
        msgEl.classList.add('text-red-600');

        const record = createLocalRecord(employeeId, type, 'Manual');
        sendRecordImmediately(record);

        msgEl.textContent = `✅ تم تسجيل الحركة يدوياً: ${movementTypeMap[type] || type}`;
        msgEl.classList.add('bg-green-100','text-green-800');
        setTimeout(()=> msgEl.classList.add('hidden'), 3500);
        this.reset();
    });

    // ------------ مسح QR وإرسال مباشر ------------
    let html5QrCode = null;
    function setupScanner() {
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            html5QrCode.stop().then(() => {
                const employeeId = decodedText;
                const statusElement = document.getElementById('scan-status');
                const type = 'Clock In';

                statusElement.textContent = `تم مسح الرمز: ${employeeId}. جارٍ تسجيل...`;
                statusElement.classList.remove('text-blue-600');
                statusElement.classList.add('text-yellow-600');

                const record = createLocalRecord(employeeId, type, 'QR');
                sendRecordImmediately(record);

                const statusEl2 = document.getElementById('last-scan-result');
                statusEl2.textContent = `✅ تم التسجيل بنجاح! نوع الحركة: ${movementTypeMap[type] || type} | رمز الموظف: ${employeeId}`;
                statusEl2.classList.remove('hidden','bg-red-100','text-red-800');
                statusEl2.classList.add('bg-green-100','text-green-800');
                setTimeout(()=> statusEl2.classList.add('hidden'), 3000);

                setTimeout(() => startScanner(), 2000);
            }).catch(err => {
                console.error("فشل إيقاف الماسح:", err);
                startScanner();
            });
        };

        const qrCodeErrorCallback = (errorMessage) => {
            // ignore frequent errors
        };

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode = new Html5Qrcode("reader");

        function startScanner() {
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const rear = devices.find(d => (d.label||'').toLowerCase().includes('back') || (d.label||'').toLowerCase().includes('rear')) || devices[0];
                    const cameraId = rear.id;
                    html5QrCode.start(cameraId, config, qrCodeSuccessCallback, qrCodeErrorCallback)
                        .then(() => {
                            document.getElementById('scan-status').textContent = 'جاهز للمسح. الرجاء توجيه الكاميرا إلى QR Code.';
                            document.getElementById('scan-status').classList.add('text-blue-600');
                        })
                        .catch(err => {
                            console.error("فشل تشغيل الكاميرا:", err);
                            document.getElementById('scan-status').textContent = 'خطأ: لا يمكن الوصول إلى الكاميرا. تأكد من الأذونات.';
                        });
                } else {
                    document.getElementById('scan-status').textContent = 'خطأ: لم يتم العثور على كاميرا.';
                }
            }).catch(err => {
                console.error("فشل في الحصول على الكاميرات:", err);
                document.getElementById('scan-status').textContent = 'خطأ: فشل في الحصول على قائمة الكاميرات.';
            });
        }

        startScanner();
    }

    // ------------ عداد QR من السجلات المحلية ------------
    function updateQRCountFromAllRecords() {
        try {
            const today = new Date().toDateString();
            const count = (allRecords || []).filter(r => r.source === 'QR' && new Date(r.timestamp).toDateString() === today).length;
            document.getElementById('qr-count-display').textContent = count.toString();
        } catch (e) { console.warn(e); }
    }

    // ------------ تحميل/تهيئة الواجهة ------------
    window.onload = function() {
        document.getElementById('login-container').classList.remove('hidden');
        document.getElementById('main-app-content').classList.add('hidden');
        document.getElementById('export-excel-btn').disabled = allRecords.length === 0;
        document.getElementById('loading-records').textContent = '';
        updateQRCountFromAllRecords();
    };

    // login handler
    function handleLogin(event) {
        event.preventDefault();
        const usernameInput = document.getElementById('username').value;
        const passwordInput = document.getElementById('password').value;
        const loginMessage = document.getElementById('login-message');

        if (usernameInput === CREDENTIALS.username && passwordInput === CREDENTIALS.password) {
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-content').classList.remove('hidden');
            loginMessage.classList.add('hidden');

            setupScanner();
            renderRecords(allRecords.slice(0, 20));
            document.getElementById('export-excel-btn').disabled = allRecords.length === 0;
        } else {
            loginMessage.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
            loginMessage.classList.remove('hidden');
            document.getElementById('password').value = '';
        }
    }
    document.getElementById('login-form').addEventListener('submit', handleLogin);

    // ------------ utility: createLocalRecord (used earlier) ------------
    function createLocalRecord(employeeId, type, source = 'QR') {
        return {
            id: `local-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,
            employee_id: String(employeeId || '').trim(),
            movement_type: type,
            timestamp: new Date().toISOString(),
            source: source
        };
    }

    // ------------ قبل إغلاق الصفحة: نحاول إرسال أي سجل عبر sendBeacon (حفظ إضافي) ------------
    window.addEventListener('beforeunload', function () {
        // نرسل آخر سجل محلي غير مُستلم إن أردنا — لكن لأننا نرسل فورًا، عادة لا توجد دفعات.
        // نترك هذا كاحتياط إذا رغبت لاحقًا بتعديل.
    });
    </script>
</body>
</html>
